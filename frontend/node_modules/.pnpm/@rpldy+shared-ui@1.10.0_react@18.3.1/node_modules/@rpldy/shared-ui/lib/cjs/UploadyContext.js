"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.createContextApi = void 0;
var _react = _interopRequireDefault(require("react"));
var _shared = require("@rpldy/shared");
var _uploadyVersion = require("./uploadyVersion");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const UploadyContext = /*#__PURE__*/_react.default.createContext(null);
const NO_INPUT_ERROR_MSG = "Uploady - Context. File input isn't available";
const createContextApi = (uploader, internalInputRef) => {
  let fileInputRef, showFileUploadOptions;
  let isUsingExternalInput = false;
  if (internalInputRef) {
    fileInputRef = internalInputRef;
  } else {
    _shared.logger.debugLog("Uploady context - didn't receive input field ref - waiting for external ref");
  }
  const getInputField = () => fileInputRef?.current;
  const getInternalFileInput = () => {
    if (fileInputRef) {
      isUsingExternalInput = true;
    }
    return fileInputRef;
  };
  const getIsUsingExternalInput = () => isUsingExternalInput;
  const onFileInputChange = () => {
    const input = getInputField();
    (0, _shared.invariant)(input, NO_INPUT_ERROR_MSG);
    input.removeEventListener("change", onFileInputChange);
    const addOptions = showFileUploadOptions;
    showFileUploadOptions = null;
    upload(input.files, addOptions);
  };
  const upload = (files, addOptions) => {
    uploader.add(files, addOptions);
  };
  (0, _uploadyVersion.registerUploadyContextVersion)();
  return {
    hasUploader: () => !!uploader,
    getInternalFileInput,
    setExternalFileInput: extRef => {
      isUsingExternalInput = true;
      fileInputRef = extRef;
    },
    getIsUsingExternalInput,
    showFileUpload: addOptions => {
      const input = getInputField();
      (0, _shared.invariant)(input, NO_INPUT_ERROR_MSG);
      showFileUploadOptions = addOptions;
      input.removeEventListener("change", onFileInputChange);
      input.addEventListener("change", onFileInputChange);
      input.value = "";
      input.click();
    },
    upload,
    processPending: uploadOptions => {
      uploader.upload(uploadOptions);
    },
    clearPending: () => {
      uploader.clearPending();
    },
    setOptions: options => {
      uploader.update(options);
    },
    getOptions: () => {
      return uploader.getOptions();
    },
    getExtension: name => {
      return uploader.getExtension(name);
    },
    abort: itemId => {
      uploader.abort(itemId);
    },
    abortBatch: batchId => {
      uploader.abortBatch(batchId);
    },
    on: (name, cb) => {
      return uploader.on(name, cb);
    },
    once: (name, cb) => {
      return uploader.once(name, cb);
    },
    off: (name, cb) => {
      return uploader.off(name, cb);
    }
  };
};
exports.createContextApi = createContextApi;
var _default = exports.default = UploadyContext;